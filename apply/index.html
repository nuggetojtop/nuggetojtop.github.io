<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>提交认证申请</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    body { 
      max-width: 420px; 
      margin: 2rem auto; 
      padding: 0 1rem; 
      font-family: "Microsoft YaHei", Arial, sans-serif;
      background-color: #f8f9fa;
    }
    .container {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    h1 {
      text-align: center;
      color: #343a40;
      margin-bottom: 1.5rem;
      font-size: 22px;
    }
    .input-group { 
      margin: 1.2rem 0; 
    }
    label { 
      display: block; 
      margin-bottom: 0.5rem; 
      font-weight: 500;
      color: #495057;
      font-size: 14px;
    }
    input { 
      width: 100%; 
      padding: 0.8rem; 
      box-sizing: border-box; 
      border: 1px solid #e9ecef;
      border-radius: 8px;
      font-size: 14px;
      background-color: #fafafa;
      outline: none;
    }
    input:focus {
      border-color: #0078d4;
      background-color: #ffffff;
      box-shadow: 0 0 0 3px rgba(0, 120, 212, 0.1);
    }
    button { 
      width: 100%;
      padding: 0.9rem; 
      border: none; 
      border-radius: 8px;
      cursor: pointer; 
      font-size: 15px;
      font-weight: 500;
      background-color: #0078d4;
      color: white;
    }
    button:hover { 
      background-color: #005a9e; 
      transform: translateY(-2px);
    }
    button:disabled { 
      background-color: #ced4da; 
      cursor: not-allowed; 
      transform: none !important;
    }
    #result { 
      margin-top: 1.2rem; 
      padding: 1rem; 
      border-radius: 8px;
      border: 1px solid #e9ecef; 
      background-color: #fafafa;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .error { 
      color: #dc3545; 
      font-weight: 500;
    }
    .back-link {
      display: block;
      text-align: center;
      margin-top: 1rem;
      color: #0078d4;
      text-decoration: none;
      font-size: 14px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    ::placeholder {
      color: #adb5bd;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>提交认证申请</h1>
    
    <!-- 核心表单：仅用户名+Token（至少8位） -->
    <div class="input-group">
      <label>用户名</label>
      <input type="text" id="applyName" placeholder="请输入你的用户名">
    </div>
    
    <div class="input-group">
      <label>Token（至少8位）</label>
      <input type="password" id="applyToken" placeholder="请输入至少8位的认证Token">
    </div>
    
    <!-- 提交按钮 -->
    <button id="submitApplyBtn">提交申请</button>
    
    <!-- 错误提示 -->
    <div id="result"></div>
    
    <!-- 返回主页链接 -->
    <a href="../index.html" class="back-link">← 返回认证页面</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    // Supabase配置
    const SUPABASE_URL = "https://qcxrfubkltphtvdfiikp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeHJmdWJrbHRwaHR2ZGZpaWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NzkxOTMsImV4cCI6MjA4MjE1NTE5M30.v6Pd4R9wDdl5Ms8JfFu6wDneuO2_pj5LB8frEN1d6q8";

    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
      document.getElementById('result').innerHTML = '<span class="error">❌ 系统初始化失败</span>';
      console.error("Supabase初始化失败:", e);
    }

    // SHA-256哈希函数（和认证页一致）
    async function sha256Hash(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
    }

    // 生成8位审核编号
    function generateCheckId() {
      return Math.floor(10000000 + Math.random() * 90000000).toString();
    }

    // 核心逻辑：提交用户名+Token → 跳转审核状态页
    async function submitApplication() {
      if (!supabase) return;

      // 获取表单值
      const username = document.getElementById('applyName').value.trim();
      const rawToken = document.getElementById('applyToken').value.trim();
      const resultEl = document.getElementById('result');
      const submitBtn = document.getElementById('submitApplyBtn');

      // 禁用按钮
      submitBtn.disabled = true;
      resultEl.innerHTML = '';

      // 表单验证
      if (!username) {
        resultEl.innerHTML = '<span class="error">❌ 用户名不能为空！</span>';
        submitBtn.disabled = false;
        return;
      }
      if (!rawToken) {
        resultEl.innerHTML = '<span class="error">❌ Token不能为空！</span>';
        submitBtn.disabled = false;
        return;
      }
      if (rawToken.length < 8) {
        resultEl.innerHTML = '<span class="error">❌ Token长度至少为8位！</span>';
        submitBtn.disabled = false;
        return;
      }

      try {
        // 1. 生成8位审核编号
        const checkId = generateCheckId();
        // 2. Token哈希
        const tokenHash = await sha256Hash(rawToken);
        // 3. 申请时间
        const applyTime = new Date().toISOString();

        // 4. 插入审核记录（初始状态：待审核）
        const { error } = await supabase
          .from('audit_records')
          .insert([{
            check_id: checkId,
            username: username,
            token_hash: tokenHash,
            apply_time: applyTime,
            status: '待审核' // 初始状态
          }]);

        if (error) throw new Error(error.message);

        // 5. 提交成功 → 跳转审核状态页（带8位编号）
        window.location.href = `../check/index.html?checkId=${checkId}`;

      } catch (err) {
        resultEl.innerHTML = `<span class="error">❌ 提交失败：${err.message}</span>`;
        console.error("提交申请错误:", err);
        submitBtn.disabled = false;
      }
    }

    // 绑定提交按钮事件
    document.addEventListener('DOMContentLoaded', function() {
      const submitBtn = document.getElementById('submitApplyBtn');
      if (submitBtn) {
        submitBtn.addEventListener('click', submitApplication);
      }
    });
  </script>
</body>
</html>
