<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>审核状态查询</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      max-width: 420px;
      margin: 3rem auto;
      padding: 0 1rem;
      font-family: "Microsoft YaHei", Arial, sans-serif;
      background-color: #f8f9fa;
    }
    .container {
      background: #ffffff;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      text-align: center;
    }
    h1 {
      color: #343a40;
      margin-bottom: 2rem;
      font-size: 20px;
    }
    .info-item {
      margin: 1.5rem 0;
      font-size: 16px;
      color: #495057;
    }
    .info-label {
      font-weight: 600;
      color: #212529;
      display: inline-block;
      width: 80px;
      text-align: right;
      margin-right: 0.5rem;
    }
    .status {
      padding: 0.4rem 1.2rem;
      border-radius: 6px;
      color: white;
      font-weight: 500;
      display: inline-block;
      margin-left: 0.5rem;
      font-size: 15px;
    }
    .status-wait { background-color: #ffc107; }
    .status-approve { background-color: #28a745; }
    .status-reject { background-color: #dc3545; }
    .error {
      color: #dc3545;
      font-size: 16px;
      font-weight: 500;
      margin-top: 2rem;
    }
    /* 修复按钮样式：确保可点击、有交互反馈 */
    #refreshBtn {
      margin-top: 1.5rem;
      padding: 0.7rem 1.5rem;
      background-color: #0078d4;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    #refreshBtn:hover {
      background-color: #005a9e;
      transform: translateY(-2px);
    }
    #refreshBtn:active {
      transform: translateY(0);
    }
    #downloadCertBtn {
      margin-top: 0.8rem;
      padding: 0.7rem 1.5rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: none;
    }
    #downloadCertBtn:hover {
      background-color: #1f8c3a;
      transform: translateY(-2px);
    }
    #downloadCertBtn:active {
      transform: translateY(0);
    }
    .back-link {
      display: inline-block;
      margin-top: 1.5rem;
      color: #0078d4;
      text-decoration: none;
      font-size: 14px;
    }
    .back-link:hover {
      text-decoration: underline;
    }
    /* 加载提示样式 */
    .loading {
      color: #0078d4;
      font-size: 16px;
      margin-top: 2rem;
    }
    .info {
      color: #6c757d;
      font-size: 16px;
      margin-top: 2rem;
    }
    .query-card {
      margin-top: 1.5rem;
      text-align: left;
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 10px;
      border: 1px solid #e9ecef;
    }
    .query-card h2 {
      font-size: 16px;
      margin-bottom: 0.6rem;
      color: #212529;
    }
    .query-card label {
      display: block;
      font-size: 13px;
      color: #495057;
      margin-top: 0.4rem;
      margin-bottom: 0.3rem;
    }
    .query-input {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      font-size: 14px;
    }
    .query-btn {
      margin-top: 0.8rem;
      width: 100%;
      padding: 0.75rem;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }
    .query-btn:hover {
      background-color: #1f8c3a;
      transform: translateY(-1px);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>认证申请审核状态</h1>
    <div id="auditInfo" class="loading">正在查询审核状态...</div>
    <!-- 修复按钮ID和样式绑定，确保可点击 -->
    <button id="refreshBtn">刷新审核状态</button>
    <button id="downloadCertBtn">下载证书</button>
    <div class="query-card">
      <h2>没有审核编号？用用户名+Token查询</h2>
      <label for="queryName">用户名</label>
      <input id="queryName" class="query-input" type="text" placeholder="请输入申请时填写的用户名">
      <label for="queryToken">Token（至少8位）</label>
      <input id="queryToken" class="query-input" type="password" placeholder="请输入对应的Token（至少8位）">
      <button id="queryByTokenBtn" class="query-btn">用户名+Token 查询</button>
    </div>
    <a href="../index.html" class="back-link">← 返回认证页面</a>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="../font-loader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.min.js"></script>
  <script>
    // Supabase配置
    const SUPABASE_URL = "https://qcxrfubkltphtvdfiikp.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjeHJmdWJrbHRwaHR2ZGZpaWtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1NzkxOTMsImV4cCI6MjA4MjE1NTE5M30.v6Pd4R9wDdl5Ms8JfFu6wDneuO2_pj5LB8frEN1d6q8";
    
    // 初始化Supabase（增加错误兜底）
    let supabase;
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
      document.getElementById('auditInfo').innerHTML = '<div class="error">❌ 系统初始化失败</div>';
      console.error("Supabase初始化失败:", e);
    }
    let latestAuditRecord = null;

    const statusConfig = {
      '待审核': { class: 'status-wait', text: '待审核', tip: '管理员将尽快审核，请耐心等待' },
      '通过': { class: 'status-approve', text: '审核通过', tip: '审核通过，可直接下载证书' },
      '审核通过': { class: 'status-approve', text: '审核通过', tip: '审核通过，可直接下载证书' },
      '拒绝': { class: 'status-reject', text: '审核拒绝', tip: '请确认Token正确或联系管理员' },
      '等待': { class: 'status-wait', text: '待审核', tip: '管理员将尽快审核，请耐心等待' }, // 兼容旧数据中的“等待”状态（与“待审核”等价）
      // 兜底：未知状态
      '': { class: 'status-wait', text: '状态未知', tip: '请联系管理员确认' }
    };
    const MIN_TOKEN_LENGTH = 8;

    function toggleDownloadButton(isApproved) {
      const downloadBtn = document.getElementById('downloadCertBtn');
      if (!downloadBtn) return;
      downloadBtn.style.display = isApproved ? 'inline-block' : 'none';
      downloadBtn.disabled = !isApproved;
    }

    async function generateCertificate(name) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      await ensureChineseFont(doc);

      const originalImgUrl = "https://cdn.jsdelivr.net/gh/nuggetojtop/nuggetojtop.github.io@main/logo.png?t=" + new Date().getTime();
      const TRANSPARENT_PNG_URL = "https://cdn.jsdelivr.net/gh/nuggetojtop/nuggetojtop.github.io@main/logo2.png?t=" + new Date().getTime();

      const now = new Date();
      const certDate = `${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
      
      doc.setFontSize(20);
      doc.text('Member Certificate (V1)', 105, 40, { align: 'center' });
      doc.setLineWidth(0.5);
      doc.line(40, 50, 170, 50);
      doc.setFontSize(14);
      doc.text(`Certification for: ${name}`, 105, 70, { align: 'center' });
      doc.text(`Valid member of QMet Group`, 105, 85, { align: 'center' });
      doc.setFontSize(12);
      doc.text(`Issue Date: ${certDate}`, 120, 100);
      doc.text(`Issued by: QMet Group`, 120, 120);

      const img1 = new Image();
      img1.crossOrigin = 'anonymous';
      img1.src = originalImgUrl;

      const img2 = new Image();
      img2.crossOrigin = 'anonymous';
      img2.src = TRANSPARENT_PNG_URL;

      const waitForImages = () => {
        return new Promise((resolve) => {
          let loaded = 0;
          const checkLoaded = () => {
            loaded++;
            if (loaded === 2) resolve();
          };

          img1.onload = checkLoaded;
          img1.onerror = () => {
            console.warn("原有图片加载失败，URL：", originalImgUrl);
            checkLoaded();
          };

          img2.onload = checkLoaded;
          img2.onerror = () => {
            console.warn("透明PNG加载失败，URL：", TRANSPARENT_PNG_URL);
            checkLoaded();
          };

          setTimeout(resolve, 5000);
        });
      };

      await waitForImages();
      if (img1.complete) {
        doc.addImage(img1, 'PNG', (210 - 120)/2, 140, 120, 0);
        console.log("原有图片绘制成功");
      } else {
        doc.setDrawColor(255, 0, 0);
        doc.rect((210 - 120)/2, 140, 120, 60);
        console.error("原有图片加载失败，请检查URL");
      }

      if (img2.complete) {
        doc.addImage(img2, 'PNG', 100, 110, 60, 0);
        console.log("透明PNG绘制成功");
      } else {
        doc.setDrawColor(0, 255, 0);
        doc.rect(100, 110, 60, 30);
        console.error("透明PNG加载失败，请检查：", TRANSPARENT_PNG_URL);
      }

      doc.save(`${name}_Member_Certificate_${certDate}.pdf`);
    }

    async function downloadCertificate() {
      if (!latestAuditRecord) return;
      const config = statusConfig[latestAuditRecord.status] || statusConfig[''];
      if (config.class !== 'status-approve') return;
      const username = latestAuditRecord.username || 'Member';
      try {
        await generateCertificate(username);
      } catch (err) {
        console.error("证书生成失败:", err);
        const auditInfoEl = document.getElementById('auditInfo');
        if (auditInfoEl) {
          const errorNode = document.createElement('div');
          errorNode.className = 'error';
          errorNode.textContent = '❌ 证书生成失败，请稍后重试';
          auditInfoEl.appendChild(errorNode);
        }
      }
    }

    // 修复：获取URL参数函数（兼容空值/非8位编号）
    function getCheckId() {
      const urlParams = new URLSearchParams(window.location.search);
      const checkId = urlParams.get('checkId') || '';
      // 验证是否为8位数字
      if (checkId.length !== 8 || isNaN(checkId)) {
        return '';
      }
      return checkId;
    }

    // 格式化时间（修复时间显示异常）
    function formatTime(isoTime) {
      if (!isoTime) return '未知时间';
      return new Date(isoTime).toLocaleString('zh-CN', {
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
    }

    async function sha256Hash(str) {
      const encoder = new TextEncoder();
      const data = encoder.encode(str);
      const hash = await crypto.subtle.digest('SHA-256', data);
      return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function renderAuditInfo(data) {
      const auditInfoEl = document.getElementById('auditInfo');
      const config = statusConfig[data.status] || statusConfig[''];
      latestAuditRecord = data;
      const isApproved = config.class === 'status-approve';
      toggleDownloadButton(isApproved);
      auditInfoEl.innerHTML = `
        <div class="info-item">
          <span class="info-label">用户名：</span>
          <span>${data.username || '未知'}</span>
        </div>
        <div class="info-item">
          <span class="info-label">提交时间：</span>
          <span>${formatTime(data.apply_time)}</span>
        </div>
        <div class="info-item">
          <span class="info-label">审核状态：</span>
          <span class="status ${config.class}">${config.text}</span>
        </div>
        <div style="color:#6c757d;font-size:14px;margin-top:1rem;">${config.tip}</div>
      `;
    }

    // 核心修复：查询审核状态函数（增加兜底、错误处理）
    async function queryAuditStatus() {
      const auditInfoEl = document.getElementById('auditInfo');
      // 重置为加载状态
      auditInfoEl.innerHTML = '<div class="loading">正在查询审核状态...</div>';
      latestAuditRecord = null;
      toggleDownloadButton(false);
      
      const checkId = getCheckId();
      
      // 1. 检查8位编号是否有效
      if (!checkId) {
        auditInfoEl.innerHTML = '<div class="error">❌ 请输入有效的8位审核编号或使用下方查询方式</div>';
        return;
      }

      // 2. 检查Supabase是否初始化成功
      if (!supabase) {
        auditInfoEl.innerHTML = '<div class="error">❌ 数据库连接失败，请刷新页面</div>';
        return;
      }

      try {
        // 3. 查询数据库（增加超时控制）
        const queryPromise = supabase
          .from('audit_records')
          .select('*')
          .eq('check_id', checkId)
          .single();
        
        // 超时兜底（5秒）
        const timeoutPromise = new Promise((_, reject) => {
          setTimeout(() => reject(new Error('查询超时')), 5000);
        });

        const { data, error } = await Promise.race([queryPromise, timeoutPromise]);

        // 4. 处理查询错误
        if (error || !data) {
          auditInfoEl.innerHTML = '<div class="error">❌ 未查询到该审核记录</div>';
          return;
        }

        renderAuditInfo(data);

      } catch (err) {
        // 7. 捕获所有异常，确保状态显示
        auditInfoEl.innerHTML = `<div class="error">❌ 查询失败：${err.message}（点击刷新重试）</div>`;
        console.error("查询审核状态错误:", err);
      }
    }

    async function queryAuditStatusByToken() {
      const auditInfoEl = document.getElementById('auditInfo');
      latestAuditRecord = null;
      toggleDownloadButton(false);
      const username = document.getElementById('queryName').value.trim();
      const rawToken = document.getElementById('queryToken').value.trim();

      if (!username) {
        auditInfoEl.innerHTML = '<div class="error">❌ 用户名不能为空</div>';
        return;
      }
      if (!rawToken) {
        auditInfoEl.innerHTML = '<div class="error">❌ Token不能为空</div>';
        return;
      }
      if (rawToken.length < MIN_TOKEN_LENGTH) {
        auditInfoEl.innerHTML = `<div class="error">❌ Token长度至少为${MIN_TOKEN_LENGTH}位</div>`;
        return;
      }
      if (!supabase) {
        auditInfoEl.innerHTML = '<div class="error">❌ 数据库连接失败，请刷新页面</div>';
        return;
      }

      auditInfoEl.innerHTML = '<div class="loading">正在查询审核状态...</div>';

      try {
        const tokenHash = await sha256Hash(rawToken);
        const { data, error } = await supabase
          .from('audit_records')
          .select('*')
          .eq('username', username)
          .eq('token_hash', tokenHash)
          .order('apply_time', { ascending: false })
          .limit(1);

        if (error) {
          throw new Error(error.message);
        }

        if (!data || data.length === 0) {
          auditInfoEl.innerHTML = '<div class="error">❌ 未查询到该审核记录</div>';
          return;
        }

        renderAuditInfo(data[0]);
      } catch (err) {
        auditInfoEl.innerHTML = `<div class="error">❌ 查询失败：${err.message}</div>`;
        console.error("用户名+Token 查询错误:", err);
      }
    }

    // 修复：页面加载+按钮点击事件绑定（确保执行）
    document.addEventListener('DOMContentLoaded', function() {
      const auditInfoEl = document.getElementById('auditInfo');
      const initialCheckId = getCheckId();
      if (initialCheckId) {
        queryAuditStatus();
      } else if (auditInfoEl) {
        auditInfoEl.innerHTML = '<div class="info">请输入审核编号或使用下方用户名+Token查询</div>';
      }

      // 绑定刷新按钮（确保按钮存在再绑定）
      const refreshBtn = document.getElementById('refreshBtn');
      if (refreshBtn) {
        refreshBtn.addEventListener('click', function() {
          if (getCheckId()) {
            queryAuditStatus();
          } else if (auditInfoEl) {
            auditInfoEl.innerHTML = '<div class="error">❌ 暂无审核编号，请使用下方用户名+Token查询</div>';
          }
        });
      } else {
        console.error("刷新按钮未找到");
      }

      const queryBtn = document.getElementById('queryByTokenBtn');
      if (queryBtn) {
        queryBtn.addEventListener('click', queryAuditStatusByToken);
      }

      const downloadBtn = document.getElementById('downloadCertBtn');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', downloadCertificate);
        toggleDownloadButton(false);
      }
    });
  </script>
</body>
</html>
